name: Deployment Protection

on:
    workflow_run:
        workflows: ["CI"]
        types: [completed]

permissions:
    contents: read
    statuses: write

jobs:
    check-deployment:
        name: Check if deployment should proceed
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        steps:
            - name: Download workflow artifact
              uses: actions/github-script@v7
              with:
                  script: |
                      const workflowRun = context.payload.workflow_run;

                      if (workflowRun.conclusion === 'failure') {
                        core.setFailed('CI workflow failed. Deployment blocked.');
                        process.exit(1);
                      }

                      console.log('âœ… CI passed. Deployment can proceed.');

            - name: Block deployment if CI failed
              if: failure()
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.repos.createCommitStatus({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        sha: context.payload.workflow_run.head_commit.id,
                        state: 'failure',
                        description: 'CI checks failed. Deployment blocked.',
                        context: 'Vercel Deployment'
                      });
